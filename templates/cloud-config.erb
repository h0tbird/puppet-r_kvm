#cloud-config

hostname: <%= @id %>

write_files:

 - path: /etc/systemd/system/docker.service.d/50-insecure-registry.conf
   content: |
    [Service]
    Environment=DOCKER_OPTS='--insecure-registry=regi01:5000'

 - path: /home/core/.bashrc
   permissions: 0644
   owner: root
   content: |
    [[ $- != *i* ]] && return
    alias ls='ls -hF --color=auto --group-directories-first'
    alias l='ls -l'
    alias ll='ls -la'
    alias grep='grep --color=auto'
    alias dim='docker images'
    alias dps='docker ps'
    alias dip="docker inspect --format '{{ .NetworkSettings.IPAddress }}'"
    alias drm='docker rm $(docker ps -qa)';
    alias drmi='docker rmi $(docker images -f '\''dangling=true'\'' -q)'

 - path: /etc/ssh/sshd_config
   permissions: 0600
   owner: root:root
   content: |
    # Use most defaults for sshd configuration.
    UsePrivilegeSeparation sandbox
    Subsystem sftp internal-sftp
    ClientAliveInterval 180
    UseDNS no
    PermitRootLogin no
    AllowUsers core
    PasswordAuthentication no
    ChallengeResponseAuthentication no
    PermitUserEnvironment yes

coreos:

 units:

  - name: etcd2.service
    command: start

  - name: fleet.service
    command: start

  - name: home-core-.ssh.mount
    command: start
    content: |
     [Mount]
     What=ssh
     Where=/home/core/.ssh
     Type=9p
     Options=trans=virtio,version=9p2000.L,ro

<% @interfaces.split(',').select { |v| v =~ /^core\d+$/ }.each_with_index do |item, n| -%>
  - name: 00-br<%= n %>.netdev
    runtime: false
    content: |
     [NetDev]
     Name=br<%= n %>
     Kind=bridge

  - name: 01-eth<%= n %>.network
    runtime: false
    content: |
     [Match]
     Name=eth<%= n %>

     [Network]
     Bridge=br<%= n %>

  - name: 02-br<%= n %>.network
    runtime: false
    content: |
     [Match]
     Name=br<%= n %>

     [Network]
     DHCP=v4

<% end -%>
 fleet:
  metadata: host=<%= @id %>
  metadata: role=master

 etcd2:
  name: <%= @id %>
  initial-cluster: core01=http://core01:2380,core01=http://core01:7001,core02=http://core02:2380,core02=http://core02:7001,core03=http://core03:2380,core03=http://core03:7001
<% if @id < 'core04' -%>
  listen-peer-urls: http://<%= @id %>:2380,http://<%= @id %>:7001
  listen-client-urls: http://127.0.0.1:2379,http://127.0.0.1:4001,http://<%= @id %>:2379,http://<%= @id %>:4001
  initial-advertise-peer-urls: http://<%= @id %>:2380,http://<%= @id %>:7001
  advertise-client-urls: http://<%= @id %>:2379,http://<%= @id %>:4001
  initial-cluster-state: new
<% else -%>
  listen-client-urls: http://127.0.0.1:2379
  proxy: on
<% end -%>
