#cloud-config

hostname: <%= @value %>

ssh_authorized_keys:
 - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAtWGpShgH4SCTM3WwsSwMScIGz/Fzvx5xp73fnj7rKGZNdkFNzKObbTgrN77UkWGw9aVazqjTErmPxzcNfW+dXYdxO0s/lUYi1jK6o1JkMv5j07LiOTqsnqJBxJLfECmcjQw6u9ECFErC+Z9TeaMUWVBRKDNWamkT0CyIN7Bg0qQ3spyeX7qNLj5dsP5w+2LE9qiUY0ouDK8CSH1Fr4t3emJqjx8lVMCDXDqBigq0GalglK/o9yW+bp9JrT1EDSH2RwBoiMrTnphHftRHwWUnr2bWLlifd4HiFrASya922asEjdq4MOwu3KGuKHPflqQ7JeGka3s3ymZA7GWUu1KvZw== marc.villacorta/root

write_files:

 - path: /etc/systemd/system/docker.service.d/50-insecure-registry.conf
   content: |
    [Service]
    Environment=DOCKER_OPTS='--insecure-registry=regi01.<%= @domain %>:5000'

 - path: /home/core/.bashrc
   permissions: 0644
   owner: root
   content: |
    [[ $- != *i* ]] && return
    alias ls='ls -hF --color=auto --group-directories-first'
    alias l='ls -l'
    alias ll='ls -la'
    alias grep='grep --color=auto'
    alias dim='docker images'
    alias dps='docker ps'
    alias dip="docker inspect --format '{{ .NetworkSettings.IPAddress }}'"
    alias drm='docker rm $(docker ps -qa)';
    alias drmi='docker rmi $(docker images -f '\''dangling=true'\'' -q)'

 - path: /etc/ssh/sshd_config
   permissions: 0600
   owner: root:root
   content: |
    # Use most defaults for sshd configuration.
    UsePrivilegeSeparation sandbox
    Subsystem sftp internal-sftp
    ClientAliveInterval 180
    UseDNS no
    PermitRootLogin no
    AllowUsers core
    PasswordAuthentication no
    ChallengeResponseAuthentication no
    PermitUserEnvironment yes

coreos:

 units:

  - name: etcd.service
    command: start

  - name: fleet.service
    command: start

  - name: home-core-.ssh.mount
    command: start
    content: |
     [Mount]
     What=ssh
     Where=/home/core/.ssh
     Type=9p
     Options=trans=virtio,version=9p2000.L,ro

<% @interfaces.split(',').select { |v| v =~ /^core\d+$/ }.each_with_index do |item, n| -%>
  - name: 00-br<%= n %>.netdev
    runtime: false
    content: |
     [NetDev]
     Name=br<%= n %>
     Kind=bridge

  - name: 01-eth<%= n %>.network
    runtime: false
    content: |
     [Match]
     Name=eth<%= n %>

     [Network]
     Bridge=br<%= n %>

  - name: 02-br<%= n %>.network
    runtime: false
    content: |
     [Match]
     Name=br<%= n %>

     [Network]
     DHCP=v4

<% end -%>
 fleet:
  metadata: host=<%= @value %>

 etcd:
  name: <%= @value %>
  addr: <%= @value %>:4001
  peer-addr: <%= @value %>:7001
<% if @value != 'core01' -%>
  peers: core01:7001
<% end -%>
