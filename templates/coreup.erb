#!/bin/bash

#------------------------------------------------------------------------------
# Definitions:
#------------------------------------------------------------------------------

NAME='core01'
DOMAIN='demo.lan'

#------------------------------------------------------------------------------
# Host network:
#------------------------------------------------------------------------------

ip l s ${NAME}_eth0 &> /dev/null || ip tuntap a d ${NAME}_eth0 m tap
brctl show br0 | grep -q ${NAME}_eth0 || brctl addif br0 ${NAME}_eth0
ip l sh ${NAME}_eth0 | grep -q UP || ip l s dev ${NAME}_eth0 up

ip l s ${NAME}_eth1 &> /dev/null || ip tuntap a d ${NAME}_eth1 m tap
brctl show br1_3 | grep -q ${NAME}_eth1 || brctl addif br1_3 ${NAME}_eth1
ip l sh ${NAME}_eth1 | grep -q UP || ip l s dev ${NAME}_eth1 up

ip l s ${NAME}_eth2 &> /dev/null || ip tuntap a d ${NAME}_eth2 m tap
brctl show br1_6 | grep -q ${NAME}_eth2 || brctl addif br1_6 ${NAME}_eth2
ip l sh ${NAME}_eth2 | grep -q UP || ip l s dev ${NAME}_eth2 up

#------------------------------------------------------------------------------
# Virtual machine:
#------------------------------------------------------------------------------

qemu-system-x86_64 \
-enable-kvm \
-name ${NAME}.${DOMAIN} \
-smp 2,sockets=2,cores=1,threads=1 \
-m 1024 \
-rtc base=utc \
-machine accel=kvm \
-boot order=c,reboot-timeout=60,strict=on \
-cpu host \
-nodefconfig \
-device sga \
-display none \
-daemonize \
\
-netdev tap,ifname=${NAME}_eth0,id=hostnet0,vhost=on,script=no,downscript=no \
-device virtio-net-pci,netdev=hostnet0,id=net0,romfile=,bus=pci.0,addr=0x3 \
\
-netdev tap,ifname=${NAME}_eth1,id=hostnet1,vhost=on,script=no,downscript=no \
-device virtio-net-pci,netdev=hostnet1,id=net1,romfile=,bus=pci.0,addr=0x4 \
\
-netdev tap,ifname=${NAME}_eth2,id=hostnet2,vhost=on,script=no,downscript=no \
-device virtio-net-pci,netdev=hostnet2,id=net2,romfile=,bus=pci.0,addr=0x5 \
\
-drive if=none,file=./coreos_production_qemu_image.img,id=drive-virtio-disk0 \
-device virtio-blk-pci,scsi=off,drive=drive-virtio-disk0,id=virtio-disk0 \
\
-fsdev local,id=conf,security_model=none,readonly,path=/root/coreos/mount \
-device virtio-9p-pci,fsdev=conf,mount_tag=config-2 \
\
-chardev socket,id=monitor,path=/var/tmp/vm/${NAME}_monitor.sock,server,nowait \
-mon chardev=monitor,id=monitor,mode=control \
\
-chardev socket,id=console,path=/var/tmp/vm/${NAME}_console.sock,server,nowait \
-device isa-serial,chardev=console,id=serial0

#------------------------------------------------------------------------------
# Console:
#------------------------------------------------------------------------------

socat -,raw,echo=0 unix-connect:/var/tmp/vm/${NAME}_console.sock; reset

