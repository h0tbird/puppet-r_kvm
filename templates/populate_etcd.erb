#!/bin/bash
#
# This file is generated by Puppet and contains a Ceph cluster configuration.
# The config is pushed to Etcd if it is not already present or has changes.

#------------------------------------------------------------------------------
# Globals:
#------------------------------------------------------------------------------

# Settings:
CLUSTER_NAME='ceph-<% @fqdn_3 %>'

# Return codes:
readonly E_BAD_CMD=10

# Commands:
readonly CMD_MD5SUM=$(type -P md5sum); [ -z "${CMD_MD5SUM}" ] && exit ${E_BAD_CMD}
readonly CMD_CAT=$(type -P cat); [ -z "${CMD_CAT}" ] && exit ${E_BAD_CMD}
readonly CMD_AWK=$(type -P awk); [ -z "${CMD_AWK}" ] && exit ${E_BAD_CMD}
readonly CMD_ETCDCTL=$(type -P etcdctl); [ -z "${CMD_ETCDCTL}" ] && exit ${E_BAD_CMD}

#------------------------------------------------------------------------------
# Compute the hash of this file:
#------------------------------------------------------------------------------

desired_hash=$(${CMD_CAT} $0 | ${CMD_MD5SUM} | ${CMD_AWK} '{ print $1 }')
current_hash=$(${CMD_ETCDCTL} get /ceph-config/${CLUSTER_NAME}/config_hash)
[ "${desired_hash}" == "${current_hash}" ] && exit 0

#------------------------------------------------------------------------------
# Push the config to Etcd:
#------------------------------------------------------------------------------

#------------------------------------------------------------------------------
# Set the new configuration hash:
#------------------------------------------------------------------------------

${CMD_ETCDCTL} put /ceph-config/${CLUSTER_NAME}/config_hash ${desired_hash}
