#------------------------------------------------------------------------------
# Global default settings:
#------------------------------------------------------------------------------

global:
  scrape_interval: 1m
  scrape_timeout: 10s
  evaluation_interval: 10s

#------------------------------------------------------------------------------
# Rule files:
#------------------------------------------------------------------------------

rule_files:
 - /etc/prometheus/prometheus.rules

#------------------------------------------------------------------------------
# File-based service discovery configurations:
#-----------------------------------------------------------------------------

scrape_configs:

- job_name: default
  file_sd_configs:
  - names: ['/etc/sd-targets/tgroups.json']

#------------------------------------------------------------------------------
# Scrape Prometheus:
#-----------------------------------------------------------------------------

- job_name: prometheus
  scrape_interval: 10s
  scheme: http
  target_groups:
  - targets:
<% @masters.each do |master| -%>
    - <%= master %><% if @domain -%>.<%= @domain %><% end -%>:9191
<% end -%>

#------------------------------------------------------------------------------
# Scrape etcd:
#-----------------------------------------------------------------------------

- job_name: etcd
  scrape_interval: 10s
  scheme: http
  target_groups:
  - targets:
<% @masters.each do |master| -%>
    - <%= master %><% if @domain -%>.<%= @domain %><% end -%>:2379
<% end -%>
    labels:
      group: masters
  - targets:
<% 12.times do |id| -%>
<% if !@masters.include?("core-#{id+1}") -%>
    - core-<%= id+1 %><% if @domain -%>.<%= @domain %><% end -%>:2379
<% end -%>
<% end -%>
    labels:
      group: proxies

#------------------------------------------------------------------------------
# Scrape cAdvisor:
#------------------------------------------------------------------------------

- job_name: cAdvisor
  scrape_interval: 10s
  scheme: http
  target_groups:
  - targets:
<% @masters.each do |master| -%>
    - <%= master %><% if @domain -%>.<%= @domain %><% end -%>:4194
<% end -%>
    labels:
      group: masters
  - targets:
<% 12.times do |id| -%>
<% if !@masters.include?("core-#{id+1}") -%>
    - core-<%= id+1 %><% if @domain -%>.<%= @domain %><% end -%>:4194
<% end -%>
<% end -%>
    labels:
      group: slaves

#------------------------------------------------------------------------------
# Scrape nodes:
#------------------------------------------------------------------------------

- job_name: node
  scrape_interval: 10s
  scheme: http
  target_groups:
  - targets:
    - kvm-1<% if @domain -%>.<%= @domain %><% end -%>:9100
    - kvm-2<% if @domain -%>.<%= @domain %><% end -%>:9100
    - kvm-3<% if @domain -%>.<%= @domain %><% end -%>:9100
